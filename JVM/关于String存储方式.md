## Java字符串存储方式

字符串只会存储在两个地方，一个是字符串常量池，一个是堆空间中

常量池维护了一个String Table，它是一个hashtable，以字符串hashcode作为键，字符串引用作为值；Java堆中存储的就是普通的字符串对象。那么如何判断字符串到底位于哪一个区域呢？有以下几种情形。

1. ```java
   String s = "123";
   ```

   判断这个常量是否存在于常量池，

   如果存在，则直接返回地址值（只不过返回的地址值分为两种情况，1是堆中的引用，2是本身常量池的地址）

   如果是引用，返回引用地址指向的堆空间对象地址值 

   如果是常量，则直接返回常量池常量的地址值，

   如果不存在，

   这个说法是错误的===》在常量池中创建该常量，并返回此常量的地址值

   **正确的说法是===》在堆中创建一个相应的对象，将创建的对象的引用存放到字符串常量池中，同时将引用返回给变量 str1 。**

   

2. ```java
   String s = new Srtring("123")
   ```

   通过new对象的方法，会执行两个操作

   1. 将字面量"123"放入常量池中，将其引用添加至String Table中（即情形一的操作）
   2. 在Java堆中创建一个字符串对象，里面的值与常量池中的"123"一致，返回引用
      - 也就是采用new 创建的**字符串对象**不进入字符串池，但是字面量”123“会进入常量池（class文件中的常量池）中。
   3. 所以，该语句会创建2个对象，一个在堆中一个在常量池中，而引用指向的是堆中的对象

   2.1 字符串相加的时候，都是静态字符串的结果会添加到字符串池，如果其中含有变量则不会进入字符串池中。

   ```java
   //静态字符串相加
   string s1 = "12"+"3";
   //含有变量 其中ab是变量
   String s1 = "ab";
   String s2 = "12"+ab;
   ```

2. ```java
   String s=new String("1")+new String("23");
   ```

   这种情况等价于

   ```java
   StringBuilder stringBuilder=new StringBuilder();
   stringBuilder.append("1").append("23");
   String s=stringBuilder.toString();
   ```

   这种情况与情形二最大的区别就是它不会在常量池中创建"123"对象，而只是创建一个堆中对象，将引用返回，可以通过字节码文件看出来

4. intern()方法

   判断这个常量是否存在于常量池。

   如果存在，则直接返回地址值（只不过地址值分为两种情况，1是堆中的引用，2是本身常量池的地址）

   如果是引用，返回引用地址指向的堆空间对象地址值

   如果是常量，则直接返回常量池常量的地址值，

   如果不存在，

   **将当前对象引用复制到常量池,并且返回的是当前对象的引用**（jdk6与jdk7有区别，这里指的是jdk7及以上的版本）

   注意这里和字面量创建的字符串是有区别的

   

参考：[一文弄懂String常量池，String常见面试题，以及intern()方法 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/92079662)

​			[(23条消息) Java技术——你真的了解String类的intern()方法吗_SEU_Calvin的博客-CSDN博客](https://blog.csdn.net/seu_calvin/article/details/52291082)

​			[(23条消息) Java中字符串的存储方式_璨若繁星的博客-CSDN博客_java字符串存储方法](https://blog.csdn.net/qq_45489824/article/details/108200885)

​			[尚硅谷宋红康JVM全套教程（详解java虚拟机）_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1PJ411n7xZ?p=127&spm_id_from=pageDriver)

